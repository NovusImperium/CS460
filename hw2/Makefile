##
# Author: Amandeep Gill
##

# define syscalls for file manipulation
# using cp/tar/mv: [syscall] [target] [sources...]
RM=rm -rf
MKDIR=mkdir -p
TAR=tar czf
CP=cp -t
MV=mv -t

## define the c/c++ compilers and compilation flags
CC=gcc
CLFLAGS=
CXX=g++
CXXFLAGS=-c -Wall -std=c++11 -MMD
DEBUG_FLAGS=-g -lprofiler

## define which homework number this makfile compiles
## will determine the name of the main file as well as the name on the tarball
HWNUM = H02
MAIN = gill$(HWNUM).cpp

# sources used by both target and test exe's
COMMON_SOURCES = 
COMMON_HEADERS = 
# all sources req'd for target exe
TARGET_SOURCES = gcd.cpp Fraction.cpp $(MAIN)
TARGET_HEADERS = gcd.h Fraction.h
# all sources req's for test exe
TEST_SOURCES = mkinput.cpp 
TEST_HEADERS = 

## build object files for all the source files
COMMON_OBJECTS = $(COMMON_SOURCES:.cpp=.o)
TARGET_OBJECTS = $(TARGET_SOURCES:.cpp=.o)
TEST_OBJECTS = $(TEST_SOURCES:.cpp=.o) 

## the following will keep a file for each source object that tracks the object's dependencies
## if any of the dependencies are modified it will trigger a recompiliation of the object
COMMON_DEPS = $(COMMON_OBJECTS:.o=.d)			
TARGET_DEPS = $(TARGET_OBJECTS:.o=.d)
TEST_DEPS = $(TEST_OBJECTS:.o=.d)

## define the exe that will be run when turned in
EXECUTABLE = $(HWNUM).out 
## this exe will only be run locally
TEST_EXECUTABLE = $(TEST_SOURCES:.cpp=.bin)

## define the sources and name of the tarball to turn in
# all files that are to be included in the tarball
INCLUDE_FILES = Makefile $(COMMON_SOURCES) $(COMMON_HEADERS) $(TARGET_SOURCES) $(TARGET_HEADERS)

# the name of the file to turn in (taken from the main file)
FILE = $(MAIN:.cpp=/)
# the name of the tarball to turn in (file_name + .tgz)
TARBALL = $(MAIN:.cpp=.tgz)
# the directory to turn the file into
DROPBOX = ~tiawatts/cs460drop/

## the name of the files used to contain the input to the exe and the output of the exe
INPUT = input
OUTPUT = output

.PHONY: all target tests run tarball turnin

## recipe to call when no recipe is specified
all: target 

## recipe for building the target exe
target: $(COMMON_SOURCES) $(TARGET_SOURCES) $(EXECUTABLE)

$(EXECUTABLE): $(COMMON_OBJECTS) $(TARGET_OBJECTS)
	$(CXX) $^ -o $@

## recipe for building the test executable
tests: $(COMMON_SOURCES) $(TEST_SOURCES) $(TEST_EXECUTABLE)

$(TEST_EXECUTABLE): $(TEST_OBJECTS)
	$(CXX) $^ -o $@

## recipe for building all exe's with debug flag and profiler
debug: $(DEBUG_EXE)

$(DEBUG_EXE): $(COMMON_OBJECTS) $(TARGET_OBJECTS)
	$(CXX) $(DEBUG_FLAGS) $^ -o $@

## tell make to include dependency files
-include $(COMMON_DEPS) $(TARGET_DEPS) $(TEST_DEPS)

## define how to get object files from source files
## the -MF $(patsubst ...) option tells the compiler to look for updated dependencies in the associated
##		.d dependencies file
.cpp.o:
	$(CXX) $(CXXFLAGS) -MF $(patsubst %.o,%.d,$@) $< -o $@

## recipe to compile 'all' and run target exe with input
run: all
	./$(EXECUTABLE) < $(INPUT) > $(OUTPUT)

## recipe to compile test exe and generate input
input: tests
	./$(TEST_EXECUTABLE) > $(INPUT)

## recipe to generate tarball with required directory name and source files
tarball:
	$(MKDIR) $(FILE)
	$(CP) $(FILE) $(INCLUDE_FILES)
	$(TAR) $(TARBALL) $(FILE)
	$(RM) $(FILE)

## recipe to turn in the assignment by moving the tarball into the dropbox folder
turnin: tarball 
	$(MV) $(DROPBOX) $(TARBALL)

## remove all files generated by this makefile
clean:
	$(RM) $(COMMON_OBJECTS) $(COMMON_DEPS) $(TARGET_DEPS) $(TARGET_OBJECTS) $(TEST_DEPS) $(TEST_OBJECTS) \
		$(EXECUTABLE) $(TEST_EXECUTABLE) $(DEBUG_EXE) $(INPUT) $(OUTPUT) $(TARBALL)

